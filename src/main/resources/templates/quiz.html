<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" href="/css/style.css">
    <!-- Add Font Awesome CDN link -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <title>Quiz</title>
    <script>
        let timeRemaining = [[${timer}]];
        let totalQuestionsAsked = 0; // Track the total number of questions asked

        console.log('Time remaining started: ', timeRemaining);

        function startTimer() {
            const timerElement = document.getElementById("timer");
            const hiddenTimerInput = document.getElementById("timeRemainingInput");

            const interval = setInterval(async function () {
                if (timeRemaining <= 0) {
                    clearInterval(interval);
                    alert("Time is up! Submitting your score.");

                    // Prepare data to submit
                    const data = {
                        timeRemaining: timeRemaining.toString(),
                        answer: '' // No answer because time has run out
                    };

                    try {
                        const response = await fetch('/submit-answer', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data), // Send as JSON
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();

                        if (result.end) {
                            // Redirect to the results page
                            window.location.href = `/quiz-results?score=${result.score}&totalQuestions=${totalQuestionsAsked}`;
                        }
                    } catch (error) {
                        console.error('Error submitting answer:', error);
                    }
                } else {
                    timeRemaining--;
                    timerElement.innerHTML = `${timeRemaining}`;
                    hiddenTimerInput.value = timeRemaining;
                    console.log('Time remaining: ', timeRemaining);
                }
            }, 1000);
        }

        function submitAnswer() {
            const answerInput = document.getElementById("answerInput");
            const timeRemainingInput = document.getElementById("timeRemainingInput");
            const questionText = document.getElementById("questionText");
            const scoreText = document.getElementById("scoreText");
            const questionCountText = document.getElementById("questionCountText");

            const data = {
                answer: answerInput.value,
                timeRemaining: timeRemainingInput.value
            };

            fetch('/submit-answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(result => {
                // Update the UI with the new question, score, etc.
                questionText.innerText = result.question;

                // Increment total questions asked
                totalQuestionsAsked++;

                scoreText.innerText = `${result.score} / ${totalQuestionsAsked}`;

                answerInput.value = ""; // Clear the input
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        window.onload = function () {
            startTimer(); // Start the timer when the page loads
            document.getElementById('answerInput').focus();
        };
    </script>
</head>
<body>
<div class="container">
    <div class="content">
        <h1 class="page-heading">Multiplications - Level: <span th:text="${level}">1</span></h1>
        <div class="side">
            <div class="clock-wrapper">
                <div class="clock" id="timer" style="background: rgb(255, 255, 255);">
                    <p><span th:text="${timer}">60</span></p>
                </div>
            </div>
            <div class="progress-wrapper">
                <div class="row">
                    <div class="blok icon-clock">
                        <i class="fas fa-check-circle" style="font-size: 20px; margin-right: 10px;"></i>
                        <span id="scoreText" th:text="${score}">0 / 0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="question-answer-container">
            <div class="question"><span id="questionText" th:text="${question}">What is 1 x 1?</span> =
            </div>
            <div class="answer">
                <form id="quizForm" onsubmit="event.preventDefault(); submitAnswer();">
                    <input type="number" class="answer-box" id="answerInput" name="answer"
                           placeholder="Enter your answer" required/>
                    <input type="hidden" id="timeRemainingInput" name="timeRemaining" th:value="${timer}"/>
                    <button type="submit" class="button">Submit Answer</button>
                </form>
            </div>
        </div>
    </div>
</div>

</body>
</html>
